<div class="recibo-wrapper" *ngIf="!loading && recibo; else loadingTpl">
  <div class="toolbar no-print">
    <a routerLink="/inventario/recibos" class="btn btn-sm btn-outline-secondary">Volver</a>
    <button class="btn btn-sm btn-outline-primary" (click)="print()">Imprimir</button>
    <button class="btn btn-sm btn-outline-success" (click)="exportJSON()">Exportar JSON</button>
  </div>

  <div class="header card">
    <div>
      <h3>Recibo #{{recibo.ReciboID}}</h3>
      <div class="meta">Fecha: {{recibo.Fecha | date:'short'}} · Cliente: {{recibo.ClienteNombre || ('ID ' + recibo.ClienteID)}}</div>
    </div>
    <div class="totales-resumen">
      <div><span class="lbl">Total Pagos</span><span class="val">{{recibo.TotalPagos | number:'1.2-2'}}</span></div>
      <div><span class="lbl">Aplicado</span><span class="val">{{recibo.TotalAplicado | number:'1.2-2'}}</span></div>
      <div><span class="lbl">Diferencia</span><span class="val" [class.neg]="(recibo.Diferencia||0)<0">{{recibo.Diferencia | number:'1.2-2'}}</span></div>
    </div>
  </div>

  <div class="grid-two">
    <section class="card">
      <h5>Pagos</h5>
      <table class="table table-sm table-striped table-border">
        <thead><tr><th>Tipo</th><th>Monto</th><th>Datos</th></tr></thead>
        <tbody>
          <tr *ngFor="let p of recibo.pagos">
            <td>{{p.TipoPago}}</td>
            <td>{{p.Monto | number:'1.2-2'}}</td>
            <td><span class="mono">{{p.Datos}}</span></td>
          </tr>
          <tr *ngIf="!recibo.pagos?.length"><td colspan="3" class="text-muted">Sin pagos</td></tr>
        </tbody>
      </table>
    </section>
    <section class="card">
      <h5>Aplicación a Facturas</h5>
      <table class="table table-sm table-striped table-border">
        <thead><tr><th>Factura</th><th>Fecha</th><th>Total</th><th>Saldo Ant.</th><th>Aplicado</th><th>Saldo Post.</th></tr></thead>
        <tbody>
          <tr *ngFor="let v of recibo.ventas">
            <td>{{v.VentaID}}</td>
            <td>{{v.FechaComp | date:'shortDate'}}</td>
            <td>{{v.TotalFactura | number:'1.2-2'}}</td>
            <td>{{v.SaldoAnterior | number:'1.2-2'}}</td>
            <td class="aplicado">{{v.ImporteAplicado | number:'1.2-2'}}</td>
            <td>{{v.SaldoPosterior | number:'1.2-2'}}</td>
          </tr>
          <tr *ngIf="!recibo.ventas?.length"><td colspan="6" class="text-muted">Sin facturas asociadas</td></tr>
        </tbody>
      </table>
    </section>
  </div>

  <section class="card">
    <h5>Observaciones</h5>
    <pre class="observaciones" *ngIf="recibo.Observaciones; else noObs">{{recibo.Observaciones}}</pre>
    <ng-template #noObs><div class="text-muted small">(Sin observaciones)</div></ng-template>
  </section>

  <section class="card audit">
    <h6>Auditoría</h6>
    <div class="audit-grid">
      <div><span class="lbl">Creado</span><span class="val">{{recibo.CreatedAt | date:'short'}}</span></div>
      <div><span class="lbl">Usuario</span><span class="val">{{recibo.CreatedBy || '-'}} </span></div>
      <div><span class="lbl">Actualizado</span><span class="val">{{recibo.UpdatedAt | date:'short'}}</span></div>
    </div>
  </section>
</div>

<ng-template #loadingTpl>
  <div class="card p-3" *ngIf="loading">Cargando...</div>
  <div class="alert alert-danger" *ngIf="error">{{error}}</div>
</ng-template>
