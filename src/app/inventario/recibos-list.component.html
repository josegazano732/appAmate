<div class="recibos-list card" role="region" aria-label="Listado de recibos" [class.compact]="compact" [attr.aria-busy]="loading ? 'true' : 'false'">
  <div class="header">
    <div class="title-block">
      <h3 class="title">Recibos</h3>
      <div class="subtitle">Cobros registrados con totales y diferencias aplicadas a facturas.</div>
      <div *ngIf="totalAll!=null" class="meta">Total global: <strong>{{totalAll}}</strong></div>
    </div>
    <div class="actions primary-actions" aria-label="Acciones principales">
      <button class="btn ghost" (click)="exportCsv()" title="Exportar CSV" aria-label="Exportar CSV"><span class="icon">⇩</span><span class="lbl">CSV</span></button>
      <button class="btn ghost" (click)="exportPdf()" title="Exportar PDF" aria-label="Exportar PDF"><span class="icon">⧉</span><span class="lbl">PDF</span></button>
      <a class="btn primary accent" routerLink="/inventario/recibos/new" title="Cargar nuevo recibo" aria-label="Nuevo recibo">Nuevo Recibo</a>
      <button type="button" class="btn ghost subtle density-toggle" (click)="toggleCompact()" [attr.aria-pressed]="compact" title="Cambiar densidad" [attr.aria-label]="'Cambiar densidad (modo ' + (compact ? 'compacto' : 'amplio') + ')'">
        <span class="icon">▤</span><span class="lbl">{{compact?'Amplio':'Compacto'}}</span>
      </button>
    </div>
  </div>

  <div class="sr-only" aria-live="polite">
    <span *ngIf="stale">Mostrando datos en caché mientras reintenta la carga.</span>
    <span *ngIf="loading">Cargando recibos…</span>
  </div>

  <div class="sub-toolbar">
    <div class="stat-block">
      <div class="stat" aria-label="Total pagos vista">
        <span class="stat-label">Pagos (vista)</span>
        <span class="stat-value">{{aggregatePagos | number:'1.2-2'}}</span>
      </div>
      <div class="stat" aria-label="Total aplicado vista">
        <span class="stat-label">Aplicado (vista)</span>
        <span class="stat-value">{{aggregateAplicado | number:'1.2-2'}}</span>
      </div>
      <div class="stat" aria-label="Diferencia global vista" *ngIf="aggregatePagos || aggregateAplicado">
        <span class="stat-label">Dif. (vista)</span>
        <span class="stat-value" [class.zero]="aggregatePagos===aggregateAplicado" [class.neg]="aggregatePagos<aggregateAplicado" [class.pos]="aggregatePagos>aggregateAplicado">{{(aggregatePagos-aggregateAplicado)| number:'1.2-2'}}</span>
      </div>
    </div>
  </div>

  <form class="filters" (submit)="onSearchChange(); $event.preventDefault();" aria-label="Filtros de búsqueda">
    <div class="field grow">
      <input class="f-input" placeholder="Buscar (cliente / observaciones)" [(ngModel)]="q" name="q" (input)="onSearchChange()" aria-label="Texto de búsqueda" />
    </div>
    <div class="field actions-inline basic-actions">
      <button type="button" class="btn subtle sm" (click)="toggleAdvanced()" [attr.aria-expanded]="advancedOpen" aria-controls="advFilters">
        Filtros Fecha <span *ngIf="activeAdvancedCount" class="pill neg" style="margin-left:6px" aria-label="Filtros avanzados activos">{{activeAdvancedCount}}</span>
      </button>
      <button type="submit" class="btn primary sm" aria-label="Aplicar filtros">Aplicar</button>
      <button *ngIf="q || fechaDesde || fechaHasta || paymentMethodId || bankId" type="button" class="btn ghost sm" (click)="clearFilters();" aria-label="Limpiar filtros">Limpiar</button>
      <button *ngIf="fechaDesde || fechaHasta || paymentMethodId || bankId || activePreset" type="button" class="btn ghost sm" (click)="clearAdvanced()" aria-label="Limpiar filtros avanzados">Limpiar avanzados</button>
    </div>
    <div class="advanced" [class.open]="advancedOpen" id="advFilters" *ngIf="advancedOpen || fechaDesde || fechaHasta">
      <div class="adv-grid">
        <div class="field">
          <label>Desde
            <input type="date" [(ngModel)]="fechaDesde" name="fechaDesde" (change)="onSearchChange(); clearPresetIfManual()" aria-label="Fecha desde" />
          </label>
        </div>
        <div class="field">
          <label>Hasta
            <input type="date" [(ngModel)]="fechaHasta" name="fechaHasta" (change)="onSearchChange(); clearPresetIfManual()" aria-label="Fecha hasta" />
          </label>
        </div>
        <div class="preset-col">
          <div class="preset-label" aria-hidden="true">Presets</div>
          <div class="presets-btns" role="group" aria-label="Presets rango de fechas">
            <button type="button" class="btn ghost xs" *ngFor="let p of datePresets" (click)="applyDatePreset(p.key)" [class.active]="activePreset===p.key" [attr.aria-pressed]="activePreset===p.key">{{p.label}}</button>
          </div>
          <div class="quick-help" aria-hidden="true">Enter o Aplicar</div>
        </div>
        <div class="field">
          <label>Método Pago
            <select [(ngModel)]="paymentMethodId" name="paymentMethodId" (change)="onSearchChange()" class="f-input" aria-label="Filtrar por método de pago">
              <option [ngValue]="null">(Todos)</option>
              <option *ngFor="let pm of paymentMethods" [ngValue]="pm.PaymentMethodID">{{pm.Nombre}}</option>
            </select>
          </label>
        </div>
        <div class="field">
          <label>Banco
            <select [(ngModel)]="bankId" name="bankId" (change)="onSearchChange()" class="f-input" aria-label="Filtrar por banco" [disabled]="!paymentMethodId">
              <option [ngValue]="null">(Todos)</option>
              <option *ngFor="let b of banks" [ngValue]="b.BankID">{{b.Nombre}}</option>
            </select>
          </label>
        </div>
      </div>
    </div>
  </form>

  <div class="table-wrap">
    <table class="table table-sm" aria-describedby="recibosCaption">
      <caption id="recibosCaption" class="sr-only">Listado paginado de recibos con totales y diferencias</caption>
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha</th>
          <th>Cliente</th>
          <th class="text-right">Pagos</th>
          <th class="text-right">Aplicado</th>
          <th class="text-right">Dif.</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of items" [class.neg-diff]="r.Diferencia < 0" [class.pos-diff]="r.Diferencia > 0" [class.zero-diff]="r.Diferencia===0" [attr.data-diff]="r.Diferencia">
          <td><span class="mono">#{{r.ReciboID}}</span></td>
          <td><span class="date-chip" [title]="r.Fecha">{{r.displayFecha || r.Fecha}}</span></td>
          <td>
            <span class="cliente" [title]="r.ClienteDisplay">{{r.ClienteDisplay}}</span>
            <span class="badge diff-badge" *ngIf="r.Diferencia !== 0" [class.neg]="r.Diferencia<0" [class.pos]="r.Diferencia>0" [title]="'Diferencia: '+ (r.Diferencia | number:'1.2-2')">{{r.Diferencia<0?'–':'+'}}{{abs(r.Diferencia) | number:'1.2-2'}}</span>
          </td>
          <td class="text-right"><span class="amount">{{r.TotalPagos | number:'1.2-2'}}</span></td>
          <td class="text-right"><span class="amount">{{r.TotalAplicado | number:'1.2-2'}}</span></td>
          <td class="text-right diff-cell">
            <span class="diff" [class.zero]="r.Diferencia===0" [class.neg]="r.Diferencia<0" [class.pos]="r.Diferencia>0">{{r.Diferencia | number:'1.2-2'}}</span>
            <span class="diff-bar-wrapper" *ngIf="r._diffPct && r.Diferencia !== 0" [attr.aria-label]="'Magnitud relativa '+ (r._diffPct| number:'1.0-0') + '%'">
              <span class="diff-bar"><span class="fill" [style.width.%]="r._diffPct" [class.neg]="r.Diferencia<0" [class.pos]="r.Diferencia>0"></span></span>
            </span>
          </td>
          <td><a class="btn btn-sm link" [routerLink]="['/inventario/recibos', r.ReciboID]" title="Ver detalle">Ver</a></td>
        </tr>
        <tr *ngIf="errorMessage && !loading">
          <td colspan="7" class="error-row">
            <div class="err-msg">
              <strong>Error:</strong> {{errorMessage}}
              <button type="button" class="btn sm ghost" (click)="load()" [disabled]="loading">
                <span *ngIf="loading">Reintentando…</span>
                <span *ngIf="!loading">Reintentar</span>
              </button>
              <span *ngIf="stale" class="stale-note">Mostrando datos en caché</span>
            </div>
          </td>
        </tr>
        <tr *ngIf="!items.length && !loading && !errorMessage"><td colspan="7" class="no-data">Sin recibos</td></tr>
        <tr *ngIf="loading"><td colspan="7" class="loading">Cargando...</td></tr>
      </tbody>
      <tfoot *ngIf="items.length">
        <tr class="totals-row">
          <td colspan="3" class="label">Totales página</td>
          <td class="text-right">{{aggregatePagos | number:'1.2-2'}}</td>
          <td class="text-right">{{aggregateAplicado | number:'1.2-2'}}</td>
          <td class="text-right">{{(aggregatePagos-aggregateAplicado) | number:'1.2-2'}}</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="pager" *ngIf="total > limit || items.length" aria-label="Paginación">
  <div class="pager-left">Página <strong>{{page}}</strong> / {{totalPages}} · Mostrando {{offset+1}} – {{endIndex}} de {{total}}</div>
    <div class="pager-mid">
      <button class="btn" (click)="pagePrev()" [disabled]="page===1">Anterior</button>
      <button class="btn" (click)="pageNext()" [disabled]="page===totalPages">Siguiente</button>
    </div>
    <div class="pager-right">
      <select class="f-input" [ngModel]="limit" (ngModelChange)="changeLimit($event)" aria-label="Items por página">
        <option [ngValue]="10">10</option>
        <option [ngValue]="25">25</option>
        <option [ngValue]="50">50</option>
        <option [ngValue]="100">100</option>
      </select>
    </div>
  </div>
</div>
